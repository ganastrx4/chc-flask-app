<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Comprar CHC con World App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.worldcoin.org/app/v1.0/sdk.js"></script>
  </head>
  <body>
    <h1>Autenticaci√≥n con World ID</h1>
    <div id="world-id-container"></div>
    <pre id="resultado"></pre>

    <hr />

    <h2>Comprar CHC</h2>
    <label for="cantidadChc">¬øCu√°ntos CHC deseas comprar?</label><br />
    <input type="number" id="cantidadChc" placeholder="Ej. 1000000" /><br /><br />
    <button onclick="comprarCHC()">Comprar</button>

    <script>
      let walletConectada = null;

      window.worldID.init("world-id-container", {
        action_id: "app_7686f9027d3e3c0b53d987a3caf1e111",
        signal: "login",
        enable_telemetry: true,
        on_success: async (verificationResponse) => {
          document.getElementById("resultado").textContent =
            "‚úÖ Verificado correctamente.\n\n" +
            JSON.stringify(verificationResponse, null, 2);

          // Conectar wallet
          if (window.ethereum) {
            try {
              const accounts = await window.ethereum.request({
                method: "eth_requestAccounts",
              });
              walletConectada = accounts[0];
              console.log("üëú Wallet conectada:", walletConectada);
              document.getElementById("resultado").textContent +=
                `\n\nüëú Wallet conectada: ${walletConectada}`;
            } catch (err) {
              console.error("‚ùå Error al conectar wallet:", err);
              alert("Error al conectar la wallet.");
            }
          } else {
            alert("No se detect√≥ World App / Wallet compatible.");
          }
        },
        on_error: (error) => {
          document.getElementById("resultado").textContent =
            "‚ùå Error de verificaci√≥n:\n\n" + error.message;
        },
      });

      async function comprarCHC() {
        const cantidadChc = parseInt(document.getElementById("cantidadChc").value);
        if (!walletConectada) return alert("Primero debes autenticarte y conectar tu wallet.");
        if (isNaN(cantidadChc) || cantidadChc <= 0)
          return alert("Ingresa una cantidad v√°lida de CHC.");

        
        const wldPorChc = 1 / 1400000;
        const cantidadWLD = cantidadChc * wldPorChc;

        // Convertir WLD a wei (hexadecimal)
        const wei = BigInt(cantidadWLD * 1e18).toString(16);

        const tx = {
          from: walletConectada,
          to: "0xdc178d65c502f9589bb1a35af08b5723f85ec168",
          value: "0x" + wei,
        };

        try {
          const txHash = await window.ethereum.request({
            method: "eth_sendTransaction",
            params: [tx],
          });

          document.getElementById("resultado").textContent +=
            `\n\nüöÄ Transacci√≥n enviada:\n${txHash}\n\nüì• Recibir√°s tus ${cantidadChc} CHC pronto.`;
        } catch (error) {
          console.error("‚ùå Error en transacci√≥n:", error);
          alert("Error al enviar la transacci√≥n:\n" + error.message);
        }
      }
    </script>
  </body>
</html>
