<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel World Chain</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #eef2f3; }
    input, button { padding: 10px; margin-top: 10px; width: 100%; max-width: 400px; }
    .token { background: white; margin: 10px 0; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>

<h2>Panel de Usuario - World Chain</h2>

<button onclick="connectWallet()">ðŸ”— Conectar Wallet</button>
<p><strong>DirecciÃ³n:</strong> <span id="walletAddress">No conectada</span></p>

<div id="balances"></div>

<h3>Enviar tokens</h3>
<select id="tokenSelect"></select>
<input type="text" id="toAddress" placeholder="DirecciÃ³n de destino">
<input type="number" id="amount" placeholder="Cantidad a enviar">
<button onclick="sendToken()">ðŸš€ Enviar</button>

<p id="status">Estado: Esperando acciÃ³n...</p>

<script>
  const TOKENS = {
    WLD: { address: "0x0000000000000000000000000000000000000000", decimals: 18 },
    CHUN: { address: "0x6b2bA4159916017267c39A3b70b507F7c1Af5eDb", decimals: 18 },
    CHC: { address: "0xde8239aEb9730D74548D65DD2fD3Ce3F42517395", decimals: 18 }
  };
  const MY_WALLET = "0xdc178d65c502f9589bb1a35af08b5723f85ec168";
  let provider, signer, userAddress;

  async function connectWallet() {
    if (!window.ethereum) return alert("MetaMask no estÃ¡ instalado.");
    provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    document.getElementById("walletAddress").textContent = userAddress;
    await mostrarBalances();
    mostrarTokensDisponibles();
  }

  async function mostrarBalances() {
    let html = "";
    const balancesDiv = document.getElementById("balances");

    for (let symbol in TOKENS) {
      const token = TOKENS[symbol];
      let balance;
      if (token.address === "0x0000000000000000000000000000000000000000") {
        balance = await provider.getBalance(userAddress);
      } else {
        const abi = ["function balanceOf(address) view returns (uint256)"];
        const contract = new ethers.Contract(token.address, abi, provider);
        balance = await contract.balanceOf(userAddress);
      }
      const formatted = ethers.formatUnits(balance, token.decimals);
      html += `<div class="token"><strong>${symbol}:</strong> ${formatted}</div>`;
    }

    balancesDiv.innerHTML = html;
  }

  function mostrarTokensDisponibles() {
    const select = document.getElementById("tokenSelect");
    select.innerHTML = "";
    for (let symbol in TOKENS) {
      const option = document.createElement("option");
      option.value = symbol;
      option.textContent = symbol;
      select.appendChild(option);
    }
  }

  async function sendToken() {
    const symbol = document.getElementById("tokenSelect").value;
    const to = document.getElementById("toAddress").value;
    const amount = parseFloat(document.getElementById("amount").value);
    const status = document.getElementById("status");
    const token = TOKENS[symbol];
    const feeAddress = MY_WALLET;

    if (!ethers.isAddress(to)) return alert("DirecciÃ³n invÃ¡lida");

    const amountBN = ethers.parseUnits(amount.toString(), token.decimals);
    const feeBN = amountBN / 100n; // 1%
    const sendBN = amountBN - feeBN;

    if (token.address === "0x0000000000000000000000000000000000000000") {
      // Enviar WLD nativo
      await signer.sendTransaction({
        to: to,
        value: sendBN
      });
      await signer.sendTransaction({
        to: feeAddress,
        value: feeBN
      });
    } else {
      const abi = [
        "function transfer(address to, uint256 amount) returns (bool)"
      ];
      const contract = new ethers.Contract(token.address, abi, signer);
      await contract.transfer(to, sendBN);
      await contract.transfer(feeAddress, feeBN);
    }

    status.textContent = `âœ… Enviado ${amount} ${symbol} (${sendBN} al destino, ${ethers.formatUnits(feeBN, token.decimals)} fee)`;
    await mostrarBalances();
  }
</script>

</body>
</html>
