<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CHC ‚Ä¢ Ver Shorts y Cobrar</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <meta name="color-scheme" content="dark light">
  <style>
    :root { color-scheme: dark; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(10px); }
    .marquee { white-space: nowrap; overflow: hidden; }
    .marquee span { display: inline-block; padding-left: 100%; animation: marquee 18s linear infinite; }
    @keyframes marquee { 0% { transform: translate(0,0) } 100% { transform: translate(-100%,0) } }
  </style>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="min-h-screen bg-gray-950 text-gray-100">
  <!-- Header -->
  <header class="p-4 md:p-6 border-b border-gray-800 sticky top-0 bg-gray-950/80 backdrop-blur z-20">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-yellow-400 flex items-center justify-center text-black font-extrabold">CH</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold">Ver Shorts y Cobrar ‚Äî CHC / CHUN</h1>
          <p class="text-xs md:text-sm text-gray-400">Canal: <a class="underline hover:text-yellow-400" target="_blank" href="https://www.youtube.com/@CharlyUNAM-Charly4k/shorts">@CharlyUNAM‚ÄëCharly4k</a></p>
        </div>
      </div>
      <button id="cobrarBtn" class="bg-yellow-400 text-black font-semibold px-4 py-2 rounded-xl hover:bg-yellow-300 transition">üí∏ Cobrar por tiempo de vista</button>
    </div>
  </header>

  <!-- Aviso de seguridad (comentarios en c√≥digo explican alternativa segura) -->
  <div class="max-w-6xl mx-auto mt-4 px-4">
    <div class="glass rounded-2xl p-4 text-sm text-gray-300">
      ‚ö†Ô∏è Este demo env√≠a la direcci√≥n a un bot de Telegram directamente desde el navegador. Para producci√≥n, usa un proxy seguro (ej. Cloudflare Worker/Netlify Function) para ocultar tu token. Revisa el bloque de c√≥digo al final.
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-3 gap-6">
    <!-- Player + Cola -->
    <section class="md:col-span-2 space-y-4">
      <!-- Reproductor -->
      <div class="glass rounded-2xl p-3">
        <div id="player" class="w-full aspect-[9/16] max-h-[80vh]"></div>
      </div>

      <!-- Controles de carga de Shorts -->
      <div class="glass rounded-2xl p-4 space-y-3">
        <h2 class="font-semibold">Cargar Shorts del canal</h2>
        <div class="text-sm text-gray-300">Pega una URL de <span class="font-mono">youtube.com/shorts/‚Ä¶</span> del canal. (Si no es del canal indicado, el sistema igual reproducir√°, pero te pedimos usar solo ese contenido.)</div>
        <div class="flex flex-col md:flex-row gap-3">
          <input id="shortUrl" type="url" placeholder="https://www.youtube.com/shorts/VIDEO_ID" class="text-black px-3 py-2 rounded-lg flex-1" />
          <button id="loadBtn" class="bg-white text-black font-semibold px-4 py-2 rounded-lg hover:bg-gray-200">Cargar</button>
          <button id="addQueueBtn" class="bg-gray-800 border border-gray-700 px-4 py-2 rounded-lg hover:bg-gray-700">Agregar a cola</button>
        </div>
        <div class="text-xs text-gray-400">Tip: Tambi√©n acepta <span class="font-mono">watch?v=</span> o <span class="font-mono">youtu.be/</span>.</div>
      </div>

      <!-- Cola -->
      <div class="glass rounded-2xl p-4 space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Cola de reproducci√≥n</h2>
          <div class="text-xs text-gray-400">Auto‚Äëavanza al terminar un Short</div>
        </div>
        <ul id="queueList" class="space-y-2 text-sm"></ul>
      </div>

      <!-- Info corrida (no mostramos pagos ni tiempo al usuario) -->
      <div class="marquee text-xs text-gray-500"><span>Reproduciendo contenido educativo y de entretenimiento ‚Äî Gracias por apoyar el ecosistema CHC/CHUN ‚ú®</span></div>
    </section>

    <!-- Cobro / Wallet -->
    <aside class="space-y-4">
      <div class="glass rounded-2xl p-4 space-y-3">
        <h2 class="font-semibold">Cobrar por tiempo de vista</h2>
        <p class="text-sm text-gray-300">Al presionar <strong>Cobrar</strong> se mostrar√° un anuncio y, despu√©s, podr√°s enviar tu wallet WLD/World Chain para recibir CHC o CHUN. No mostramos el monto ganado.</p>
        <button class="bg-yellow-400 text-black font-semibold px-4 py-2 rounded-lg hover:bg-yellow-300 w-full" id="cobrarBtn2">üí∏ Cobrar</button>
      </div>

      <div class="glass rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold">Tu Wallet (elige una opci√≥n)</h3>

        <!-- Opci√≥n 1: Copiar desde UNO -->
        <div class="space-y-2">
          <label class="text-sm text-gray-300">1) Copiar desde UNO (recomendado)</label>
          <div class="flex gap-2">
            <a target="_blank" href="https://worldcoin.org/mini-app?app_id=app_a4f7f3e62c1de0b9490a5260cb390b56" class="px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 hover:bg-gray-700">Abrir UNO para copiar</a>
            <button id="pegarDesdePortapapeles" class="px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 hover:bg-gray-700">Pegar desde portapapeles</button>
          </div>
        </div>

        <!-- Opci√≥n 2: Manual (snippet del usuario) -->
        <div id="manualWalletSection" class="mt-2 flex flex-col items-stretch">
          <p class="mb-2 text-sm">üîÅ Pega tu direcci√≥n WLD aqu√≠:</p>
          <input type="text" id="manualWallet" placeholder="0x‚Ä¶ tu direcci√≥n en World Chain" class="text-black px-4 py-2 rounded mb-2 w-full">
          <button onclick="enviarWallet()" class="bg-yellow-500 hover:bg-yellow-600 px-6 py-2 rounded text-black font-bold">üì§ Enviar</button>
        </div>

        <p id="statusMsg" class="text-sm text-green-400 min-h-[1.5rem]"></p>
      </div>

      <div class="glass rounded-2xl p-4 text-xs text-gray-400">
        <p>Despu√©s de enviar tu wallet ver√°s este mensaje: <em>‚ÄúEn breve se te enviar√°n tus criptomonedas (m√°ximo 24 horas).‚Äù</em></p>
      </div>
    </aside>
  </main>

  <!-- Modal de anuncio -->
  <div id="adModal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-30">
    <div class="glass rounded-2xl p-6 max-w-md w-full space-y-4">
      <h3 class="text-lg font-semibold">Anuncio</h3>
      <p class="text-sm text-gray-300">Gracias por apoyar. Este espacio est√° reservado para tu creatividad (banner, video o HTML de anunciante).</p>
      <div class="rounded-xl border border-gray-800 p-4 text-center">[ Tu anuncio aqu√≠ ]</div>
      <button id="cerrarAnuncio" class="w-full bg-white/90 text-black font-semibold px-4 py-2 rounded-xl hover:bg-white">Continuar</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="px-4 py-8 border-t border-gray-800 text-center text-xs text-gray-500">
    ¬© <span id="year"></span> CHC / CHUN ‚Äî Hecho con üíõ para la comunidad.
  </footer>

  <script>
    // =====================
    // CONFIGURACI√ìN
    // =====================
    const telegramToken = '8010490851:AAGXRC8_OlcfCeL53VgJ_ALqmbRuT691Wlk';
    const chatId = '7613604212';
    // Opcional: si defines un proxy seguro, se usar√° en lugar del Bot API directo
    const SECURE_PROXY_URL = '' // p.ej. 'https://tu-dominio.workers.dev/send'

    // =====================
    // YOUTUBE IFRAME API
    // =====================
    let player = null;
    let isPlaying = false;
    let lastTick = 0;
    let totalWatchSeconds = 0;
    const watchedIds = new Set();

    // Cola sencilla
    const queue = [];
    const queueList = document.getElementById('queueList');

    function onYouTubeIframeAPIReady() {
      // Creamos un lienzo vac√≠o; cargamos videos bajo demanda
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: null,
        playerVars: {
          autoplay: 0,
          controls: 1,
          rel: 0,
          modestbranding: 1,
          enablejsapi: 1,
          playsinline: 1,
          origin: location.origin
        },
        events: {
          'onStateChange': onPlayerStateChange,
          'onReady': () => {}
        }
      });
    }

    function onPlayerStateChange(e) {
      const state = e.data;
      if (state === YT.PlayerState.PLAYING) {
        isPlaying = true;
        lastTick = performance.now();
        const id = player.getVideoData()?.video_id;
        if (id) watchedIds.add(id);
        tick();
      } else if (state === YT.PlayerState.PAUSED) {
        accrue();
        isPlaying = false;
      } else if (state === YT.PlayerState.ENDED) {
        accrue();
        isPlaying = false;
        // Avanza en la cola
        playNextInQueue();
      }
    }

    function tick() {
      if (!isPlaying) return;
      const now = performance.now();
      const delta = (now - lastTick) / 1000; // s
      totalWatchSeconds += delta;
      lastTick = now;
      requestAnimationFrame(tick);
    }

    function accrue() {
      if (!isPlaying) return;
      const now = performance.now();
      totalWatchSeconds += (now - lastTick) / 1000;
      lastTick = now;
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        accrue();
        isPlaying = false;
      }
    });

    function parseYouTubeId(url) {
      try {
        const u = new URL(url);
        if (u.hostname === 'youtu.be') return u.pathname.slice(1);
        if (u.searchParams.get('v')) return u.searchParams.get('v');
        const shorts = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{5,})/);
        if (shorts) return shorts[1];
      } catch (_) {}
      // Permitir pegar directamente un ID
      if (/^[a-zA-Z0-9_-]{5,}$/i.test(url)) return url;
      return null;
    }

    function loadVideoById(id) {
      if (!player || !id) return;
      player.loadVideoById({ videoId: id, startSeconds: 0, suggestedQuality: 'highres' });
    }

    function addToQueue(id) {
      queue.push(id);
      renderQueue();
    }

    function renderQueue() {
      queueList.innerHTML = '';
      queue.forEach((id, idx) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-900 border border-gray-800 rounded-lg px-3 py-2';
        li.innerHTML = `
          <div class="flex items-center gap-2 text-xs">
            <span class="px-2 py-0.5 rounded bg-gray-800">${idx+1}</span>
            <code class="text-gray-300">${id}</code>
          </div>
          <div class="flex items-center gap-2">
            <button class="text-xs px-2 py-1 rounded bg-gray-800 hover:bg-gray-700" data-play="${id}">‚ñ∂Ô∏è</button>
            <button class="text-xs px-2 py-1 rounded bg-gray-800 hover:bg-gray-700" data-remove="${idx}">üóëÔ∏è</button>
          </div>`;
        queueList.appendChild(li);
      });
    }

    function playNextInQueue() {
      if (queue.length === 0) return;
      const next = queue.shift();
      renderQueue();
      loadVideoById(next);
    }

    // Controles UI
    document.getElementById('loadBtn').addEventListener('click', () => {
      const url = document.getElementById('shortUrl').value.trim();
      const id = parseYouTubeId(url);
      if (!id) return alert('URL o ID inv√°lido.');
      loadVideoById(id);
    });

    document.getElementById('addQueueBtn').addEventListener('click', () => {
      const url = document.getElementById('shortUrl').value.trim();
      const id = parseYouTubeId(url);
      if (!id) return alert('URL o ID inv√°lido.');
      addToQueue(id);
      document.getElementById('shortUrl').value = '';
    });

    queueList.addEventListener('click', (e) => {
      const playId = e.target.getAttribute('data-play');
      const removeIdx = e.target.getAttribute('data-remove');
      if (playId) {
        loadVideoById(playId);
      } else if (removeIdx !== null) {
        queue.splice(Number(removeIdx), 1);
        renderQueue();
      }
    });

    // Botones Cobrar -> muestra anuncio y luego wallet
    const cobrarBtn = document.getElementById('cobrarBtn');
    const cobrarBtn2 = document.getElementById('cobrarBtn2');
    const adModal = document.getElementById('adModal');
    const cerrarAnuncio = document.getElementById('cerrarAnuncio');

    function abrirAnuncio() { adModal.classList.remove('hidden'); adModal.classList.add('flex'); }
    function cerrarAnuncioFn() { adModal.classList.add('hidden'); adModal.classList.remove('flex'); }

    cobrarBtn.addEventListener('click', abrirAnuncio);
    cobrarBtn2.addEventListener('click', abrirAnuncio);
    cerrarAnuncio.addEventListener('click', cerrarAnuncioFn);

    // Pegar desde portapapeles
    document.getElementById('pegarDesdePortapapeles').addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();
        document.getElementById('manualWallet').value = text.trim();
      } catch (err) {
        alert('No se pudo leer el portapapeles. Pega manualmente.');
      }
    });

    // Env√≠o de wallet a Telegram + mensaje final
    async function enviarAlDestino(payload) {
      const msg = `Nuevo cobro por tiempo de vista\n\n` +
        `Wallet: ${payload.wallet}\n` +
        `Segundos vistos: ${Math.round(payload.seconds)}\n` +
        `Videos vistos: ${Array.from(watchedIds).join(', ') || 'n/d'}\n` +
        `User Agent: ${navigator.userAgent}\n` +
        `Fecha: ${new Date().toISOString()}`;

      try {
        if (SECURE_PROXY_URL) {
          // Envia al proxy propio (POST JSON)
          const r = await fetch(SECURE_PROXY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: msg })
          });
          if (!r.ok) throw new Error('Proxy respondi√≥ con error');
        } else {
          // Env√≠o directo al Bot API (expones token en el frontend)
          const url = `https://api.telegram.org/bot${telegramToken}/sendMessage?chat_id=${encodeURIComponent(chatId)}&text=${encodeURIComponent(msg)}`;
          const r = await fetch(url, { method: 'GET' });
          if (!r.ok) throw new Error('Telegram respondi√≥ con error');
        }
        return true;
      } catch (err) {
        console.error(err);
        return false;
      }
    }

    async function enviarWallet() {
      const input = document.getElementById('manualWallet');
      const wallet = (input.value || '').trim();
      if (!/^0x[0-9a-fA-F]{40}$/.test(wallet)) {
        return alert('Ingresa una direcci√≥n v√°lida (0x‚Ä¶ de 42 caracteres).');
      }
      accrue(); // Asegura acumular segundos recientes
      const ok = await enviarAlDestino({ wallet, seconds: totalWatchSeconds });
      const status = document.getElementById('statusMsg');
      if (ok) {
        status.textContent = 'En breve se te enviar√°n tus criptomonedas (m√°ximo 24 horas).';
        status.classList.remove('text-red-400');
        status.classList.add('text-green-400');
      } else {
        status.textContent = 'No se pudo completar el env√≠o. Intenta de nuevo m√°s tarde.';
        status.classList.remove('text-green-400');
        status.classList.add('text-red-400');
      }
    }

    // Exponer funci√≥n al bot√≥n inline (del snippet del usuario)
    window.enviarWallet = enviarWallet;

    // A√±o din√°mico
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!--
  =====================
  OPCI√ìN SEGURA (RECOMENDADA)
  =====================
  Ejemplo de Cloudflare Worker (proxy) para ocultar el token:

  export default {
    async fetch(request, env) {
      if (request.method !== 'POST') return new Response('Method Not Allowed', { status: 405 });
      const { text } = await request.json();
      const token = env.TELEGRAM_BOT_TOKEN; // almacena en Variables de entorno
      const chatId = env.TELEGRAM_CHAT_ID;
      const url = `https://api.telegram.org/bot${token}/sendMessage`;
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId, text }) });
      return new Response(await r.text(), { status: r.status, headers: { 'Access-Control-Allow-Origin': '*' } });
    }
  }

  Luego asigna la URL a SECURE_PROXY_URL en el frontend.
  -->
</body>
</html>
