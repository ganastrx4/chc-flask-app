<script>
  const telegramToken = '8010490851:AAGXRC8_OlcfCeL53VgJ_ALqmbRuT691Wlk';
  const chatId = '7613604212';

  const initialShorts = [
    'https://www.youtube.com/shorts/HS81XKWh1N4',
    'https://www.youtube.com/shorts/hK2lwzhp5sc',
    'https://www.youtube.com/shorts/hh_4iOFkSOs'
  ];

  let player, isPlaying = false, lastTick = 0, totalWatchSeconds = 0;
  const master = [], queue = [];

  // Inicializa reproductor
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      videoId: null,
      playerVars: { playsinline: 1 },
      events: { 'onStateChange': onPlayerStateChange, 'onReady': initMaster }
    });
  }

  function parseId(url) {
    try {
      const u = new URL(url);
      if (u.hostname === 'youtu.be') return u.pathname.slice(1);
      if (u.searchParams.get('v')) return u.searchParams.get('v');
      const m = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]+)/);
      return m ? m[1] : null;
    } catch { return null; }
  }

  function initMaster() {
    initialShorts.forEach(u => {
      const id = parseId(u);
      if (id) master.push({ id, url: u, seconds: 0, plays: 0 });
    });
    renderMaster();
  }

  function renderMaster() {
    const ul = document.getElementById('masterList');
    ul.innerHTML = '';
    master.forEach((v) => {
      const li = document.createElement('li');
      li.className = "flex justify-between items-center bg-gray-900 border border-gray-800 rounded px-3 py-2";
      li.innerHTML = `
        <div class="text-xs">
          <div class="font-medium">${v.id}</div>
          <div class="text-gray-400">‚è± ${Math.round(v.seconds)}s ¬∑ üîÅ ${v.plays}</div>
        </div>
        <div class="flex gap-2">
          <button onclick="playVideo('${v.id}')" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 text-xs">‚ñ∂Ô∏è</button>
          <button onclick="addQueue('${v.id}')" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 text-xs">‚ûï</button>
        </div>`;
      ul.appendChild(li);
    });
  }

  function renderQueue() {
    const ul = document.getElementById('queueList');
    ul.innerHTML = '';
    queue.forEach((id, i) => {
      const li = document.createElement('li');
      li.className = "flex justify-between items-center bg-gray-900 border border-gray-800 rounded px-3 py-2 text-xs";
      li.innerHTML = `<span>#${i+1} ${id}</span><button onclick="playVideo('${id}')" class="px-2 py-1 bg-gray-800 rounded">‚ñ∂Ô∏è</button>`;
      ul.appendChild(li);
    });
  }

  function playVideo(id) {
    player.loadVideoById(id);
  }
  function addQueue(id) { queue.push(id); renderQueue(); }
  function nextQueue() { if (queue.length) playVideo(queue.shift()); renderQueue(); }

  function onPlayerStateChange(e) {
    const id = player.getVideoData()?.video_id;
    if (!id) return;
    const v = master.find(x => x.id === id);
    if (!v) return;

    if (e.data === YT.PlayerState.PLAYING) {
      if (!isPlaying) { v.plays++; isPlaying = true; lastTick = performance.now(); tick(id); }
    } else if (e.data === YT.PlayerState.PAUSED) {
      isPlaying = false;
    } else if (e.data === YT.PlayerState.ENDED) {
      isPlaying = false; nextQueue();
    }
  }

  function tick(id) {
    if (!isPlaying) return;
    const now = performance.now();
    const delta = (now - lastTick) / 1000;
    totalWatchSeconds += delta;
    lastTick = now;
    const v = master.find(x => x.id === id);
    if (v) v.seconds += delta;
    renderMaster();
    requestAnimationFrame(() => tick(id));
  }

  // --- Enviar Wallet al bot ---
  async function enviarWallet() {
    const w = document.getElementById('manualWallet').value.trim();
    if (!w) return alert("Ingresa tu wallet");
    const detalle = master.map(v => `${v.id}: ${Math.round(v.seconds)}s, ${v.plays}x`).join("\n");
    const msg = `üí∏ Nuevo cobro\n\nWallet: ${w}\nTotal: ${Math.round(totalWatchSeconds)}s\n\n${detalle}`;
    
    await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ chat_id: chatId, text: msg })
    });
    document.getElementById('statusMsg').textContent = "‚úÖ En breve se te enviar√°n tus criptomonedas (m√°x. 24h).";
  }

  // --- Modal de anuncio ---
  const adModal = document.getElementById('adModal');
  document.getElementById('cobrarBtn').onclick = () => { adModal.classList.replace('hidden','flex'); };
  document.getElementById('cobrarBtn2').onclick = () => { adModal.classList.replace('hidden','flex'); };
  document.getElementById('cerrarAnuncio').onclick = () => { 
    adModal.classList.replace('flex','hidden'); 
    // Aqu√≠ ya queda visible la caja de Wallet (ya est√° en el HTML).
    document.querySelector("#manualWallet").focus();
  };

  document.getElementById('year').textContent = new Date().getFullYear();
</script>
