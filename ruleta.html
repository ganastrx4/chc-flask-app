<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Predicciones WLD/USDT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: linear-gradient(to bottom right, #1a1a2e, #16213e);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      padding: 40px 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #0f3460;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
    }
    h1, h2 {
      color: #f9ca24;
    }
    button {
      background-color: #f9ca24;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #f6b93b;
    }
    .prediction-log p {
      margin: 5px 0;
    }
    .success { color: lightgreen; }
    .fail { color: red; }
  </style>
</head>
<body>
<div class="container">
  <h1>Predicciones del precio WLD/USDT</h1>
  <p>Precio actual (4 dígitos): <span id="currentPrice">...</span></p>
  <button onclick="iniciarPredicciones()">Iniciar Predicciones</button>
  <h2>Predicción:</h2>
  <div id="resultadoPrediccion">Esperando predicción...</div>

  <h2>Historial:</h2>
  <div class="prediction-log" id="historial"></div>

  <h2>Aciertos: <span id="aciertos">0</span> | Fallos: <span id="fallos">0</span></h2>

  <hr>
  <h2>¡Apoya el proyecto CharlyCoin!</h2>
  <p>Estamos construyendo herramientas para ayudar a los traders a mejorar sus predicciones.</p>
  <p>Dirección para donaciones WLD: <span id="wallet">0xdc178d65c502f9589bb1a35af08b5723f85ec168</span></p>
  <button onclick="copiar()">Copiar dirección</button>
</div>

<script>
let precioAnterior = null;
let prediccion = null;
let aciertos = 0;
let fallos = 0;
let chart = null;

async function obtenerPrecio() {
  const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=WLDUSDT');
  const data = await res.json();
  return parseFloat(parseFloat(data.price).toFixed(4));
}

async function obtenerDatosHistoricos() {
  const res = await fetch('https://api.binance.com/api/v3/klines?symbol=WLDUSDT&interval=5m&limit=60');
  const data = await res.json();
  return data.map(d => ({
    time: new Date(d[0]),
    close: parseFloat(d[4])
  }));
}

async function analizarIndicadores(datos) {
  const rsi = calcularRSI(datos, 14);
  const sma = calcularSMA(datos, 14);
  const macd = calcularMACD(datos);

  const ultimoRSI = rsi.length > 0 ? rsi[rsi.length - 1] : null;
  const ultimoMACD = macd.macdLine.length > 0 ? macd.macdLine[macd.macdLine.length - 1] : 0;
  const ultimoSignal = macd.signalLine.length > 0 ? macd.signalLine[macd.signalLine.length - 1] : 0;

  if (!ultimoRSI) return 'sin datos';

  if (ultimoRSI < 30 && ultimoMACD > ultimoSignal) {
    return 'subira';
  } else if (ultimoRSI > 70 && ultimoMACD < ultimoSignal) {
    return 'bajara';
  } else {
    return 'estable';
  }
}

function calcularRSI(datos, periodo) {
  const rsi = [];
  for (let i = periodo; i < datos.length; i++) {
    const precios = datos.slice(i - periodo, i).map(d => d.close);
    const ganancias = precios.filter((_, index) => precios[index] > precios[index - 1]);
    const perdidas = precios.filter((_, index) => precios[index] < precios[index - 1]);
    const rs = ganancias.length / (perdidas.length || 1);
    rsi.push(100 - (100 / (1 + rs)));
  }
  return rsi;
}

function calcularSMA(datos, periodo) {
  const sma = [];
  for (let i = periodo; i < datos.length; i++) {
    const precios = datos.slice(i - periodo, i).map(d => d.close);
    sma.push(precios.reduce((a, b) => a + b, 0) / periodo);
  }
  return sma;
}

function calcularMACD(datos) {
  const ema12 = calcularEMA(datos, 12);
  const ema26 = calcularEMA(datos, 26);
  const macdLine = ema12.map((v, i) => v - ema26[i]);
  const signalLine = calcularEMA(macdLine, 9);
  return { macdLine, signalLine };
}

function calcularEMA(datos, periodo) {
  let k = 2 / (periodo + 1);
  let ema = [datos[0].close];
  for (let i = 1; i < datos.length; i++) {
    ema.push((datos[i].close - ema[i - 1]) * k + ema[i - 1]);
  }
  return ema;
}

function actualizarGrafico(data) {
  const labels = data.map(d => d.time.toLocaleTimeString());
  const precios = data.map(d => d.close);
  if (chart) chart.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Precio WLD/USDT',
        data: precios,
        borderColor: '#f9ca24',
        backgroundColor: 'rgba(249,202,36,0.2)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      scales: {
        x: { display: false },
        y: { beginAtZero: false }
      },
      plugins: {
        legend: { labels: { color: '#fff' } }
      }
    }
  });
}

async function ejecutarPrediccion() {
  const datos = await obtenerDatosHistoricos();
  const actual = datos[datos.length - 1].close;
  document.getElementById('currentPrice').textContent = actual.toFixed(4);
  precioAnterior = actual;
  actualizarGrafico(datos);

  prediccion = await analizarIndicadores(datos);
  document.getElementById('resultadoPrediccion').textContent =
    `Se predice que el precio ${prediccion} en los próximos 5 minutos.`;

  setTimeout(async () => {
    const nuevoDatos = await obtenerDatosHistoricos();
    const futuro = nuevoDatos[nuevoDatos.length - 1].close;
    const exito = (
      (prediccion === 'subira' && futuro > precioAnterior) ||
      (prediccion === 'bajara' && futuro < precioAnterior)
    );

    const log = document.createElement('p');
    log.className = exito ? 'success' : 'fail';
    log.textContent = `Predicción: ${prediccion}. Precio de ${precioAnterior} a ${futuro} => ${exito ? '✅ ACERTASTE' : '❌ FALLASTE'}`;
    document.getElementById('historial').prepend(log);

    if (exito) aciertos++; else fallos++;
    document.getElementById('aciertos').textContent = aciertos;
    document.getElementById('fallos').textContent = fallos;
  }, 5 * 60 * 1000);
}

function copiar() {
  const wallet = document.getElementById('wallet').innerText;
  navigator.clipboard.writeText(wallet).then(() => {
    alert('✅ Dirección copiada al portapapeles');
  });
}

function iniciarPredicciones() {
  ejecutarPrediccion();
  setInterval(() => {
    const ahora = new Date();
    const segundos = ahora.getSeconds();
    const minutos = ahora.getMinutes();
    if ((minutos % 5 === 4 && segundos >= 30) || (minutos % 5 === 0 && segundos < 30)) {
      ejecutarPrediccion();
    }
  }, 1000);
}
</script>

</body>
</html>
